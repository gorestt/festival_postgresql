<%- include("../partials/layout_top", { title }) %>
<div class="d-flex justify-content-between align-items-end gap-3 flex-wrap mb-3">
  <div>
    <h1 class="h4 mb-1">Расписание</h1>
    <div class="text-white-50">Сводный календарь выступлений по всем фестивалям.</div>
  </div>
  <% if (isAnyRole(["ORGANIZER","ADMIN"])) { %>
    <a class="btn btn-primary" href="/schedule/new"><i class="bi bi-plus-circle me-1"></i>Добавить выступление</a>
  <% } %>
</div>

<form class="card card-glass shadow-sm mb-4" method="get" action="/schedule">
  <div class="card-body p-3 p-md-4 row g-2 align-items-end">
    <div class="col-12 col-md-8">
      <label class="form-label">Фильтр по фестивалю</label>
      <select class="form-select" name="festival">
        <option value="">Все фестивали</option>
        <% festivals.forEach(f => { %>
          <option value="<%= f.id %>" <%= festivalId===String(f.id) ? 'selected' : '' %>><%= f.name %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-12 col-md-4 d-grid">
      <button class="btn btn-outline-light" type="submit"><i class="bi bi-funnel me-1"></i>Применить</button>
    </div>
  </div>
</form>

<div class="card card-glass shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-dark table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Время</th>
            <th>Фестиваль</th>
            <th>Сцена</th>
            <th>Артист</th>
            <th class="text-end">Аудитория</th>
            <% if (isAnyRole(["ORGANIZER","ADMIN"])) { %><th class="text-end">Действия</th><% } %>
          </tr>
        </thead>
        <tbody>
          <% if (!items.length) { %>
            <tr><td colspan="6" class="text-center text-white-50 py-4">Нет данных</td></tr>
          <% } %>
          <% items.forEach(p => { %>
            <tr>
              <td class="text-white-50">
                <div><%= new Date(p.start_time).toLocaleString("ru-RU") %></div>
                <div class="small">до <%= new Date(p.end_time).toLocaleTimeString("ru-RU") %></div>
              </td>
              <td><a class="link-light" href="/festivals/<%= p.festival_id %>"><%= p.festival_name %></a></td>
              <td><%= p.stage_name %></td>
              <td><%= p.artist_name %></td>
              <td class="text-end"><%= p.expected_attendance || "—" %></td>
              <% if (isAnyRole(["ORGANIZER","ADMIN"])) { %>
                <td class="text-end">
                  <div class="d-flex justify-content-end gap-2">
                    <a class="btn btn-sm btn-outline-light" href="/schedule/<%= p.id %>/edit"><i class="bi bi-pencil"></i></a>
                    <form method="post" action="/schedule/<%= p.id %>?_method=DELETE" onsubmit="return confirm('Удалить выступление?');">
                      <button class="btn btn-sm btn-outline-danger" type="submit"><i class="bi bi-trash"></i></button>
                    </form>
                  </div>
                </td>
              <% } %>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<%- include("../partials/layout_bottom") %>
